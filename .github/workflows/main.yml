name: Daily Analytics

on:
  schedule:
    - cron: "0 17 * * *"   # 01:00 UTC daily
  workflow_dispatch:

jobs:
  run-analytics:
    runs-on: ubuntu-latest
    env:
      MONGO_URI: ${{ secrets.MONGO_URI }}
      MONGO_DB: ${{ secrets.MONGO_DB }}
      PYTHONUNBUFFERED: "1"
      ATLAS_PUBLIC_KEY: ${{ secrets.ATLAS_PUBLIC_KEY }}
      ATLAS_PRIVATE_KEY: ${{ secrets.ATLAS_PRIVATE_KEY }}
      ATLAS_GROUP_ID: ${{ secrets.ATLAS_GROUP_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Ensure jq is installed
        shell: bash
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y jq
          fi

      - name: Add runner IP to Atlas access list
        id: add_ip
        shell: bash
        run: |
          IP=$(curl -s https://api.ipify.org)
          echo "Runner IP: $IP"
          COMMENT="gha-$(date +%Y%m%d-%H%M%S)"
          PAYLOAD=$(jq -n --arg ip "$IP" --arg comment "$COMMENT" '[{ipAddress:$ip, comment:$comment}]')

          RESP=$(curl -s -w "\n%{http_code}" -u "$ATLAS_PUBLIC_KEY:$ATLAS_PRIVATE_KEY" --digest \
            -H "Content-Type: application/json" \
            -H "Accept: application/vnd.atlas.2023-01-01+json" \
            -X POST "https://cloud.mongodb.com/api/atlas/v2/groups/$ATLAS_GROUP_ID/accessList" \
            --data "$PAYLOAD")

          BODY=$(echo "$RESP" | sed '$d'); CODE=$(echo "$RESP" | tail -n1)
          echo "$BODY"

          if [ "$CODE" = "201" ] || [ "$CODE" = "200" ]; then
            CREATED=true
            # give Atlas a moment to propagate
            sleep 5
          elif [ "$CODE" = "409" ]; then
            echo "IP already present in access list."
            CREATED=false
          else
            echo "Failed to add IP (HTTP $CODE)"; exit 1
          fi

          echo "IP_ADDED=$IP" >> "$GITHUB_OUTPUT"
          echo "CREATED=$CREATED" >> "$GITHUB_OUTPUT"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('server/requirements.txt') }}
          restore-keys: |
            pip-${{ runner.os }}-

      - name: Install dependencies
        run: pip install -r server/requirements.txt

      - name: Run analytics
        run: python server/scripts/run_daily_analytics.py

      - name: Remove IP from Atlas access list
        if: always()
        shell: bash
        run: |
          IP="${{ steps.add_ip.outputs.IP_ADDED }}"
          CREATED="${{ steps.add_ip.outputs.CREATED }}"
          if [ -z "$IP" ] || [ "$CREATED" != "true" ]; then
            echo "No newly created IP entry to remove."; exit 0
          fi
          ENC_IP=$(python3 -c "import urllib.parse,sys; print(urllib.parse.quote(sys.argv[1], safe=''))" "$IP")
          RESP=$(curl -s -w "\n%{http_code}" -u "$ATLAS_PUBLIC_KEY:$ATLAS_PRIVATE_KEY" --digest \
            -H "Accept: application/vnd.atlas.2023-01-01+json" \
            -X DELETE "https://cloud.mongodb.com/api/atlas/v2/groups/$ATLAS_GROUP_ID/accessList/$ENC_IP")
          BODY=$(echo "$RESP" | sed '$d'); CODE=$(echo "$RESP" | tail -n1)
          echo "$BODY"
          if [ "$CODE" = "200" ] || [ "$CODE" = "202" ] || [ "$CODE" = "204" ]; then
            echo "Removed IP $IP"
          else
            echo "Failed to remove IP (HTTP $CODE)"
          fi